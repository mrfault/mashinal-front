<template>
   <div class="registrationMarks index">
      <div class="container">
         <div class="row">
            <div class="col">
               <h2 class="registrationMarks__title">{{ $t('registration_marks') }}</h2>

               <div class="registrationMarks__filters">
                  <div class="registrationMarks__filters-item">
                     <svg fill="none" viewBox="0 0 20 29" height="29" width="20" xmlns="http://www.w3.org/2000/svg">
                        <g xmlns="http://www.w3.org/2000/svg" clip-path="url(#clip0_2752_3219)">
                           <path d="M20 -0.666504H0V12.6665H20V-0.666504Z" fill="#EF3340"></path>
                           <path d="M20 -0.666504H0V3.77783H20V-0.666504Z" fill="#00B5E2"></path>
                           <path d="M20 8.22217H0V12.6665H20V8.22217Z" fill="#509E2F"></path>
                           <path d="M10.125 7.625C9.22754 7.625 8.5 6.89746 8.5 6C8.5 5.10254 9.22754 4.375 10.125 4.375C10.4048 4.375 10.6681 4.44574 10.898 4.57031C10.5374 4.21769 10.0442 4 9.5 4C8.39543 4 7.5 4.89543 7.5 6C7.5 7.10457 8.39543 8 9.5 8C10.0442 8 10.5374 7.7823 10.898 7.42969C10.6681 7.55426 10.4048 7.625 10.125 7.625Z" fill="#F0F0F0"></path>
                           <path d="M11.375 4.875L11.5902 5.48035L12.1705 5.20449L11.8946 5.78473L12.5 6L11.8946 6.21527L12.1705 6.79551L11.5902 6.51965L11.375 7.125L11.1598 6.51965L10.5795 6.79551L10.8554 6.21527L10.25 6L10.8554 5.78473L10.5795 5.20449L11.1598 5.48035L11.375 4.875Z" fill="#F0F0F0"></path>
                        </g>
                        <rect xmlns="http://www.w3.org/2000/svg" x="0.602151" y="15.0108" width="18.7957" height="12.7957" rx="1.80645" fill="white"></rect>
                        <path class="text" xmlns="http://www.w3.org/2000/svg" d="M9.39327 24.4194H10.632L8.02552 18.3979H6.82982L4.18896 24.4194H5.38466L5.918 23.1462H8.85993L9.39327 24.4194ZM6.3309 22.157L7.39757 19.628L8.44703 22.157H6.3309Z" fill="#364152"></path>
                        <path class="text" xmlns="http://www.w3.org/2000/svg" d="M10.7788 18.3979L10.7702 19.4043H14.2111L10.667 23.6022V24.4194H15.8111V23.4129H12.224L15.7681 19.2065V18.3979H10.7788Z" fill="#364152"></path>
                        <rect xmlns="http://www.w3.org/2000/svg" x="0.602151" y="15.0108" width="18.7957" height="12.7957" rx="1.80645" stroke="#9AA4B2" stroke-width="1.2043"></rect>
                        <defs xmlns="http://www.w3.org/2000/svg">
                           <clipPath id="clip0_2752_3219">
                              <rect width="20" height="12" rx="2" fill="white"></rect>
                           </clipPath>
                        </defs>
                     </svg>

                     <svg width="30" height="46" viewBox="0 0 30 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_8077_50420)">
                           <path d="M30 -0.0214844H0V19.9781H30V-0.0214844Z" fill="#EF3340"/>
                           <path d="M30 -0.0214844H0V6.64502H30V-0.0214844Z" fill="#00B5E2"/>
                           <path d="M30 13.3115H0V19.978H30V13.3115Z" fill="#509E2F"/>
                           <path d="M15.1875 12.416C13.8413 12.416 12.75 11.3247 12.75 9.97852C12.75 8.63232 13.8413 7.54102 15.1875 7.54102C15.6073 7.54102 16.0022 7.64713 16.347 7.83398C15.8061 7.30506 15.0663 6.97852 14.25 6.97852C12.5931 6.97852 11.25 8.32166 11.25 9.97852C11.25 11.6354 12.5931 12.9785 14.25 12.9785C15.0663 12.9785 15.8061 12.652 16.347 12.123C16.0022 12.3099 15.6073 12.416 15.1875 12.416Z" fill="#F0F0F0"/>
                           <path d="M17.0625 8.29102L17.3854 9.19904L18.2558 8.78525L17.842 9.65561L18.75 9.97852L17.842 10.3014L18.2558 11.1718L17.3854 10.758L17.0625 11.666L16.7396 10.758L15.8692 11.1718L16.283 10.3014L15.375 9.97852L16.283 9.65561L15.8692 8.78525L16.7396 9.19904L17.0625 8.29102Z" fill="#F0F0F0"/>
                        </g>
                        <rect x="1.04827" y="23.6293" width="27.9032" height="20.4624" rx="2.79032" fill="#1B2434"/>
                        <path d="M14.0627 38.511H15.9761L11.95 29.21H10.1031L6.02393 38.511H7.87085L8.69466 36.5445H13.2389L14.0627 38.511ZM9.33245 35.0165L10.9801 31.11L12.6011 35.0165H9.33245Z" fill="#9AA4B2"/>
                        <path d="M16.2029 29.21L16.1896 30.7646H21.5045L16.0302 37.2487V38.511H23.9759V36.9564H18.4352L23.9095 30.459V29.21H16.2029Z" fill="#9AA4B2"/>
                        <rect x="1.04827" y="23.6293" width="27.9032" height="20.4624" rx="2.79032" stroke="#364152" stroke-width="1.86021"/>
                        <defs>
                           <clipPath id="clip0_8077_50420">
                              <rect y="0.978516" width="30" height="18" rx="4" fill="white"/>
                           </clipPath>
                        </defs>
                     </svg>

                     <form-select
                        :options="getRegionNumbers"
                        :clear-placeholder="true"
                        :clear-option="false"
                        :new-label="false"
                        v-model="form.serial_number"
                        has-search
                     />

                     <form-select
                        :options="numbers"
                        :clear-placeholder="true"
                        :clear-option="false"
                        :new-label="false"
                        :searchInputLength="1"
                        v-model="form.serial_letter1"
                        has-search
                     />

                     <form-select
                        :options="numbers"
                        :clear-placeholder="true"
                        :clear-option="false"
                        :new-label="false"
                        :searchInputLength="1"
                        v-model="form.serial_letter2"
                        has-search
                     />

                     <form-numeric-input
                        :maxlength="3"
                        :float="true"
                        :invalid="$v.car_number.$error"
                        @change="$v.$touch()"
                        v-model="form.car_number"
                     />
                  </div>
               </div>

               <PlatesGrid
                  :items="getRegistrationMarks?.data"
                  :showFavoriteBtn="true"
                  v-model="loading"
                  v-if="getRegistrationMarks?.data.length"
               >
                  <template #head>
                     <Cap :className="'mb40'">
                        <template #left>
                           <h3>{{ $t('announcements') }}</h3>
                        </template>

                        <template #right>
                           <form-select
                              :label="$t('sorting_2')"
                              :options="sortItems"
                              :clearPlaceholder="true"
                              :clear-option="false"
                              :allowClear="false"
                              :objectInValue="true"
                              v-model="form.sorting"
                           />
                        </template>
                     </Cap>
                  </template>
               </PlatesGrid>

               <pagination
                  v-if="getRegistrationMarks?.meta?.total_pages > 1"
                  :page-count="getRegistrationMarks?.meta?.total_pages"
                  :value="page"
                  @change-page="changePage"
               />

               <no-results
                  v-if="!getRegistrationMarks?.data.length"
                  :text="$t('empty_result')"
                  :template="'new'"
                  :url="'/images/empty_result.svg'"
               >
               </no-results>

               <HandleIds :items="handleIdsOptions" />
            </div>
         </div>
      </div>
   </div>
</template>

<script>
   import PlatesGrid from "~/components/announcements/PlatesGrid.vue";
   import NoResults from "~/components/elements/NoResults.vue";
   import HandleIds from "~/components/announcements/HandleIds.vue";
   import Cap from "~/components/elements/Cap.vue";
   import CustomDropdown from "~/components/elements/CustomDropdown.vue";
   import { mapGetters } from "vuex";
   import { minLength } from "vuelidate/lib/validators";

   export default {
      name: 'PlatesPage',

      head() {
         return this.$headMeta({
            title: this.$t('registration_marks'),
            // description: this.$t('meta-registration_marks')
         });
      },

      nuxtI18n: {
         paths: {
            az: '/qeydiyyat-nisanlari'
         }
      },

      components: {
         Cap,
         PlatesGrid,
         NoResults,
         HandleIds,
         CustomDropdown
      },

      transition: 'fade-y-20',

      data() {
         return {
            timeout: null,
            page: 1,

            form: {
               serial_number: '',
               serial_letter1: '',
               serial_letter2: '',
               car_number: '',
               price_from: '',
               price_to: '',
               currency: '',
               region_id: '',
               sorting: { key: 'created_at', value: 'desc', name: this.$t('show_by_date') }
            },

            numbers: [
               { name: 'A' },
               { name: 'B' },
               { name: 'C' },
               { name: 'D' },
               { name: 'E' },
               { name: 'F' },
               { name: 'G' },
               { name: 'H' },
               { name: 'I' },
               { name: 'J' },
               { name: 'K' },
               { name: 'L' },
               { name: 'M' },
               { name: 'N' },
               { name: 'O' },
               { name: 'P' },
               { name: 'Q' },
               { name: 'R' },
               { name: 'S' },
               { name: 'T' },
               { name: 'U' },
               { name: 'V' },
               { name: 'W' },
               { name: 'X' },
               { name: 'Y' },
               { name: 'Z' }
            ],
            currencies: [
               { id: 1, name: 'AZN' },
               { id: 2, name: 'USD' }
            ],
            sortItems: [
               { key: 'created_at', value: 'desc', name: this.$t('show_by_date') },
               { key: 'price_asc', value: 'asc', name: this.$t('show_cheap_first') },
               { key: 'price_desc', value: 'desc', name: this.$t('show_expensive_first') }
            ]
         }
      },

      methods: {
         changePage(e) {
            this.$store.commit('mutate',{ property: 'loadingData', value: true });
            this.page = e;
            this.scrollTo('.registrationMarks__filters', [-15, -50]);
         },

         setInitialValues() {
            this.$route.query?.filters?.slice(1).split('&').forEach(query => {
               if (query.split('=')[0] === 'page') this.page = +query.split('=')[1];

               for (const item in this.form) {
                  if (query.split('=')[0] === item) {
                     if (item === 'region_id'|| item === 'currency') {
                        this.form[item] = +query.split('=')[1];
                     } else {
                        this.form[item] = query.split('=')[1];
                     }
                  } else if (typeof this.form[item] === 'object' && query.split('=')[0] !== 'page') {
                     if (query.split('=')[0] === 'sort_by') {
                        this.form.sorting.key = query.split('=')[1];
                     } else {
                        this.form.sorting.value = query.split('=')[1];
                     }

                     this.sortItems.forEach(item => {
                        if (item.key === this.form.sorting.key && item.value === this.form.sorting.value) {
                           this.form.sorting.name = item.name;
                        }
                     });
                  }
               }
            });
         }
      },

      computed: {
         ...mapGetters({
            getRegionNumbers: 'getRegionNumbers',
            getRegistrationMarks: 'getRegistrationMarks',
            cities: 'sellOptions',
            loading: 'loadingData'
         }),

         crumbs() {
            return [{ name: this.$t('registration_marks') }]
         },

         handleIdsOptions() {
            let ids = [];

            ids.push({
               type: 'plate',
               ids: [...this.getRegistrationMarks?.data?.map(item => item.id)]
            });

            return ids;
         }
      },

      watch: {
         page() {
            const query = new URLSearchParams();

            for (const key in this.form) {
               const value = this.form[key];

               if (value !== '') {
                  if (key !== 'sorting') {
                     query.append(key, value);
                  } else {
                     query.append('sort_by', value.key);
                     query.append('sort_order', value.value);
                  }
               }
            }

            this.$store.dispatch('fetchRegistrationMarks', `?page=${this.page}&${query.toString()}`);

            this.$router.push({
               query: { filters: `?page=${this.page}&${query.toString()}` }
            })
         },

         form: {
            deep: true,
            handler: function () {
               this.$store.commit('mutate',{ property: 'loadingData', value: true });

               const query = new URLSearchParams();

               for (const key in this.form) {
                  const value = this.form[key];
                  if (value !== '') {
                     if (key === 'serial_number') {
                        this.form.serial_number = this.form.serial_number.split('-')[0].replace(/\s/g, "");
                        query.append('serial_number', value);
                     } else if (key === 'sorting') {
                        query.append('sort_by', value.key);
                        query.append('sort_order', value.value);
                     } else {
                        query.append(key, value);
                     }
                  }
               }

               this.$router.push({
                  query: { filters: `?page=1&${query.toString()}` }
               })

               clearTimeout(this.timeout);
               this.timeout = setTimeout(() => {
                  this.$store.dispatch('fetchRegistrationMarks', `?page=1&${query.toString()}`);
               }, 300);

               this.page = 1;
            }
         },
      },

      mounted() {
         this.setInitialValues();
      },

      async asyncData({ store }) {
         await store.dispatch('fetchRegionNumbers');
         await store.dispatch('fetchRegistrationMarks');
         await store.dispatch('getOptions');
      },

      validations: {
         car_number: { minLength: minLength(3) }
      }
   }
</script>

<style lang="scss">
   .registrationMarks {
      &__title {
         margin-top: 8px;
         color: #121926;
         font-size: 32px;
         font-weight: 600;
         line-height: 38px;
      }

      &__hero {
         position: relative;
         width: 100%;
         height: 280px;
         border-radius: 8px;
         overflow: hidden;
         background: url("/images/registrationMarks__bg.png") center center / cover no-repeat;

         &:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            //max-width: 744px;
            width: 85%;
            height: 100%;
            background: linear-gradient(90deg, #081A3E -10.98%, rgba(0, 0, 0, 0) 100%);
         }

         &-text {
            position: absolute;
            left: 64px;
            bottom: 48px;
            z-index: 2;
         }

         &-title {
            font-weight: 700;
            font-size: 40px;
            line-height: 48px;
            color: #FFFFFF;
            margin: 0;
         }

      }

      &__filters {
         display: flex;
         align-items: center;
         justify-content: center;
         width: 100%;
         height: 105px;
         border-radius: 12px;
         margin-top: 32px;
         background: url("/images/plates_filters_bg.png") center center / cover no-repeat;

         &-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: #FFFFFF;

            svg {
               min-width: 30px;
               height: 38px;

               &:last-of-type {
                  display: none;
               }
            }

            .form-group {
               width: 72px;

               .select-menu {
                  &_label {
                     height: 44px;
                  }
               }

               .text-input {
                  input {
                     height: 44px;
                     padding: 0 12px;
                  }
               }

               &:first-of-type {
                  width: 160px;
               }
            }
         }
      }

      &.index {
         padding-top: 32px;

         .pagination {
            li {
               button {
                  background-color: transparent;
               }

               &.active {
                  button {
                     color: unset;
                     background: #F9FAFB;
                     border-radius: 8px;
                     border: 1px solid #00000021;

                     &:after {
                        content: unset;
                     }
                  }
               }
            }
         }
      }
   }

   .dark-mode {
      .registrationMarks {
         &__filters {
            &-item {
               background-color: #121926;

               .form-group {
                  .select-menu {
                     &_label {
                        background-color: #1B2434 !important;

                        .text-truncate {
                           color: #CDD5DF;
                        }
                     }
                  }

                  .text-input {
                     input {
                        color: #CDD5DF;
                        background-color: #1B2434 !important;
                     }
                  }
               }

               svg {
                  &:first-of-type {
                     display: none;
                  }

                  &:last-of-type {
                     display: block;
                  }
               }
            }
         }

         &.index {
            .pagination {
               li {
                  &.active {
                     button {
                        color: #000000;
                     }
                  }
               }
            }
         }
      }
   }

   @media (max-width: 992px) {
      .registrationMarks {
         &__filters {
            height: 100px;
            background: unset;
            background-color: #FFFFFF;
            border: 2px solid #121926;
         }
      }

      .dark-mode {
         .registrationMarks {
            &__filters {
               border-color: #1B2434;
               background-color: #1B2434;

               &-item {
                  background-color: #1B2434;

                  .form-group {
                     .select-menu {
                        &_label {
                           background-color: #121926 !important;

                           .text-truncate {
                              color: #CDD5DF;
                           }
                        }
                     }

                     .text-input {
                        input {
                           color: #CDD5DF;
                           background-color: #121926 !important;
                        }
                     }
                  }
               }
            }
         }
      }
   }

   @media (max-width: 570px) {
      .registrationMarks {
         &__title {
            margin-top: 0;
            font-size: 20px;
            line-height: 24px;
         }

         &__filters {
            height: 68px;

            &-item {
               gap: 8px;
               padding: 0;

               .form-group {
                  width: 57px;

                  .select-menu {
                     &_label {
                        padding: 0 12px;
                     }
                  }

                  &:first-of-type {
                     width: 100px;
                  }
               }
            }
         }

         &.index {
            position: relative;

            .col {
               position: unset;
            }

            .container {
               padding: 12px !important;
            }

            .registrationMarksGrid {
               margin-top: 30px;
            }
         }
      }
   }
</style>
